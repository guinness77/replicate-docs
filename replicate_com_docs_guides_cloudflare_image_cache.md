Docs

Search documentation`⌘K`

Get started

Collapse sidebar

[Run a model from Node.js](https://replicate.com/docs/get-started/nodejs) [Run a model from Google Colab](https://replicate.com/docs/get-started/google-colab) [Run a model from Python](https://replicate.com/docs/get-started/python) [Fine-tune an image model](https://replicate.com/docs/get-started/fine-tune-with-flux)

Guides

[Build a website with Next.js](https://replicate.com/docs/guides/nextjs) [Build a Discord bot with Python](https://replicate.com/docs/guides/discord-bot) [Build an app with SwiftUI](https://replicate.com/docs/guides/swiftui) [Cache images with Cloudflare](https://replicate.com/docs/guides/cloudflare-image-cache) [Use realtime speech with OpenAI](https://replicate.com/docs/guides/openai-realtime) [Push your own model](https://replicate.com/docs/guides/push-a-model) [Push a Diffusers model](https://replicate.com/docs/guides/push-a-diffusers-model) [Push a Transformers model](https://replicate.com/docs/guides/push-a-transformers-model) [Handle webhooks with Val Town](https://replicate.com/docs/guides/build-a-webhook-notifier-with-val-town) [Deploy a custom model](https://replicate.com/docs/guides/deploy-a-custom-model) [Push a model using GitHub Actions](https://replicate.com/docs/guides/push-a-model-using-github-actions) [Set up a CI/CD pipeline](https://replicate.com/docs/guides/continuous-model-deployment) [Get a GPU on Brev](https://replicate.com/docs/guides/get-a-gpu-on-brev) [Get a GPU on Lambda Labs](https://replicate.com/docs/guides/get-a-gpu-on-lambda-labs) [Working with LoRAs](https://replicate.com/docs/guides/working-with-loras)

ComfyUI

[Craft generative AI workflows with ComfyUI](https://replicate.com/docs/guides/comfyui) [Use ComfyUI manager](https://replicate.com/docs/guides/comfyui/comfyui-manager) [Start by running the ComfyUI examples](https://replicate.com/docs/guides/comfyui/examples) [Popular ComfyUI custom nodes](https://replicate.com/docs/guides/comfyui/custom-nodes) [Run your ComfyUI workflow on Replicate](https://replicate.com/docs/guides/comfyui/run-comfyui-on-replicate) [Run ComfyUI with an API](https://replicate.com/docs/guides/comfyui/run-comfyui-with-an-api)

Hypermedia

[Build AI apps fast with hypermedia](https://replicate.com/docs/guides/hypermedia) [What is hypermedia, and why use it for AI apps?](https://replicate.com/docs/guides/hypermedia/what-is-hypermedia) [Building a face swapping app with Val Town, HTMX, and Replicate](https://replicate.com/docs/guides/hypermedia/build-hypermedia-app)

Instant ID

[Make images of real people instantly with InstantID](https://replicate.com/docs/guides/instant-id) [Run InstantID with an API](https://replicate.com/docs/guides/instant-id/run-instant-id-with-an-api)

Language models

[Prompt and run open-source large language models (LLMs)](https://replicate.com/docs/guides/language-models) [How to use open source language models](https://replicate.com/docs/guides/language-models/how-to-use) [Use cases for open source language models](https://replicate.com/docs/guides/language-models/use-cases) [Popular open source language models and their use cases](https://replicate.com/docs/guides/language-models/popular-models) [How to prompt open source large language models](https://replicate.com/docs/guides/language-models/how-to-prompt) [Advanced prompting for open source large language models](https://replicate.com/docs/guides/language-models/advanced-prompting)

Llava

[Talk to images with Llava 13B](https://replicate.com/docs/guides/llava)

Model best practices

[Best practices for Replicate models](https://replicate.com/docs/guides/model-best-practices)

Photomaker

[Generate photos of real people with Photomaker](https://replicate.com/docs/guides/photomaker)

Stable Diffusion

[Make art with Stable Diffusion](https://replicate.com/docs/guides/stable-diffusion) [How to use Stable Diffusion](https://replicate.com/docs/guides/stable-diffusion/how-to-use) [Image to image (img2img) with Stable Diffusion](https://replicate.com/docs/guides/stable-diffusion/image-to-image) [Inpainting with Stable Diffusion](https://replicate.com/docs/guides/stable-diffusion/inpainting) [Outpainting with Stable Diffusion](https://replicate.com/docs/guides/stable-diffusion/outpainting) [Fine-tuning Stable Diffusion](https://replicate.com/docs/guides/stable-diffusion/fine-tuning) [Using ControlNet with Stable Diffusion](https://replicate.com/docs/guides/stable-diffusion/controlnet) [Fast Stable Diffusion: Turbo and latent consistency models (LCMs)](https://replicate.com/docs/guides/stable-diffusion/turbo-and-latent-consistency) [A to Z of Stable Diffusion](https://replicate.com/docs/guides/stable-diffusion/glossary)

Upscaling images

[Upscale images with AI models](https://replicate.com/docs/guides/upscaling-images) [Upscaling images with Real-ESRGAN](https://replicate.com/docs/guides/upscaling-images/real-esrgan) [Fixing faces with GFPGAN and Codeformer](https://replicate.com/docs/guides/upscaling-images/gfpgan-and-codeformer) [Upscaling images with SwinIR](https://replicate.com/docs/guides/upscaling-images/swinir) [Upscaling images with ControlNet tile](https://replicate.com/docs/guides/upscaling-images/controlnet-tile) [Upscaling images with Ultimate SD Upscale](https://replicate.com/docs/guides/upscaling-images/sd-ultimate-upscale)

Whisper

[Turn speech to text with WhisperX](https://replicate.com/docs/guides/whisper) [Run WhisperX with an API](https://replicate.com/docs/guides/whisper/run-whisperx-with-an-api)

Topics

Models

[About models](https://replicate.com/docs/topics/models) [Run a model](https://replicate.com/docs/topics/models/run-a-model) [Create a model](https://replicate.com/docs/topics/models/create-a-model) [Publish a model](https://replicate.com/docs/topics/models/publish-a-model) [Model versions](https://replicate.com/docs/topics/models/versions) [Model hardware](https://replicate.com/docs/topics/models/hardware) [Private and public models](https://replicate.com/docs/topics/models/private-models) [Training destinations](https://replicate.com/docs/topics/models/models-as-training-destinations) [Delete a model](https://replicate.com/docs/topics/models/delete-a-model)

Predictions

[About predictions](https://replicate.com/docs/topics/predictions) [Create a prediction](https://replicate.com/docs/topics/predictions/create-a-prediction) [Input files](https://replicate.com/docs/topics/predictions/input-files) [Output files](https://replicate.com/docs/topics/predictions/output-files) [Prediction lifecycle](https://replicate.com/docs/topics/predictions/lifecycle) [Share a prediction](https://replicate.com/docs/topics/predictions/share-a-prediction) [Rate limits](https://replicate.com/docs/topics/predictions/rate-limits) [Safety checking](https://replicate.com/docs/topics/predictions/safety-checking) [Data retention](https://replicate.com/docs/topics/predictions/data-retention) [Streaming output](https://replicate.com/docs/topics/predictions/streaming)

Deployments

[About deployments](https://replicate.com/docs/topics/deployments) [Create a deployment](https://replicate.com/docs/topics/deployments/create-a-deployment) [View deployments](https://replicate.com/docs/topics/deployments/view-deployments) [Delete a deployment](https://replicate.com/docs/topics/deployments/delete-a-deployment)

Webhooks

[About webhooks](https://replicate.com/docs/topics/webhooks) [Set up webhooks](https://replicate.com/docs/topics/webhooks/setup-webhook) [Receive webhooks](https://replicate.com/docs/topics/webhooks/receive-webhook) [Verify webhooks](https://replicate.com/docs/topics/webhooks/verify-webhook) [Test your webhook code](https://replicate.com/docs/topics/webhooks/testing-webhook-code)

Organizations

[About organizations](https://replicate.com/docs/topics/organizations)

Billing

[About billing](https://replicate.com/docs/topics/billing)

Site policy

[About subprocessors](https://replicate.com/docs/topics/site-policy/subprocessors)

Reference

[How does Replicate work?](https://replicate.com/docs/reference/how-does-replicate-work) [Client libraries](https://replicate.com/docs/reference/client-libraries) [HTTP API](https://replicate.com/docs/reference/http) [OpenAPI schema](https://replicate.com/docs/reference/openapi) [Open source](https://replicate.com/docs/reference/open-source)

![image](https://github.com/user-attachments/assets/e873eee7-d6b1-4582-8d66-1409474a52f9)

This guide will show you how to build a [free](https://developers.cloudflare.com/images/pricing/#images-free) hosted [Cloudflare Worker](https://developers.cloudflare.com/workers) that:

- Generates images using Replicate.
- Caches output files in durable storage.
- Serves images dynamically with \[transformations\]( [https://developers.cloudflare.com/images/transform-images/](https://developers.cloudflare.com/images/transform-images/)
transform-via-url/) like scaling, cropping, and filters.

Tip

Want to skip ahead to the completed project? Check out the GitHub repo at [replicate/cloudflare-image-cache](https://github.com/replicate/cloudflare-image-cache)

## [Anchor for why-build-this](https://replicate.com/docs/guides/cloudflare-image-cache\#why-build-this) Why build this?

- **Persistence:** When you run models on Replicate that generate output files (like images), those files are automatically deleted after an hour. If you want to keep them for long-term use, you need to save them somewhere.
- **Performance:** AI models take time and resources to run. Caching your generated output files helps you avoid repeatedly running a model using the same inputs.
- **Flexibility:** Cloudflare [Transformations](https://developers.cloudflare.com/images/transform-images/transform-via-url/) let you serve images in different sizes and formats, with operations like cropping, blurring, and filtering.

## [Anchor for what-is-cloudflare](https://replicate.com/docs/guides/cloudflare-image-cache\#what-is-cloudflare) What is Cloudflare?

You might know of Cloudflare as a DNS provider, or as a CDN, or as a DDoS protection service.
But Cloudflare is also a platform for building modern web applications.
We run a lot of Replicate's own infrastructure on Cloudflare, and we're big fans.

Cloudflare has [dozens of products](https://developers.cloudflare.com/products/) for building web applications, but in this guide we'll be using just a few of them:

- [Cloudflare Workers](https://developers.cloudflare.com/workers) for running your code in the cloud.
- [Cloudflare Images](https://developers.cloudflare.com/images) for storing and serving images.
- [Cloudflare Workers KV](https://developers.cloudflare.com/workers/runtime-apis/kv) for caching metadata.

## [Anchor for what-are-we-building](https://replicate.com/docs/guides/cloudflare-image-cache\#what-are-we-building) What are we building?

You know those websites that generate placeholder images for web design prototypes? You give it a width and height and it generates a placeholder image of that size.

We're going to build one of those, but with a bit more pizzaz:

![tired-and-wired](https://github.com/user-attachments/assets/53ce4032-b9bb-4403-a1a7-955b23ef1ad9)

We'll call it "Placeholder Zoo".

To build this app, we'll create a Cloudflare Worker that does the following:

- Takes image dimensions and a short text prompt as part of the URL path: `https://example.com/800x600/sunglasses-sloth`.
- Enhances the short prompt from the URL to make a better image prompt.
- Generates an image using the [Flux Schnell](https://replicate.com/black-forest-labs/flux-schnell) model on Replicate.
- Stores the generated image in Cloudflare Images.
- Caches the generated image metadata in Cloudflare KV.
- Uses Cloudflare Transformations to dynamically serve that pre-generated and cached image at the requested dimensions.

## [Anchor for prerequisites](https://replicate.com/docs/guides/cloudflare-image-cache\#prerequisites) Prerequisites

Here's what you'll need to build this project:

- A [Cloudflare account](https://www.cloudflare.com/plans/free/). You can sign up and [run workers for free](https://workers.cloudflare.com/).
- A [Replicate account](https://replicate.com/)
- [Node.js 20](https://nodejs.org/en/download/prebuilt-installer) or later
- [Git](https://chatgpt.com/share/673d65dc-8e50-8003-8ce2-4bc7053d0e3a), for storing your code changes as you build.

## [Anchor for step-1-set-up-your-project](https://replicate.com/docs/guides/cloudflare-image-cache\#step-1-set-up-your-project) Step 1: Set up your project

The Cloudflare team maintains an official CLI tool called [create-cloudflare](https://npm.im/create-cloudflare) (also known as C3) that helps you set up and deploy new applications to Cloudflare. It's an npm package that you can run directly from the command line.

Run the following command to get started:

Copy

```
npm create cloudflare@latest placeholder-zoo -- \
--type=hello-world \
--lang=ts \
--deploy \
--git
```

This commands takes care of a lot of things for you:

- Creates a new git repository.
- Generates a new hello-world Cloudflare worker script written in TypeScript.
- Installs all the npm packages you need.
- Configures a `.gitignore` file to avoid committing secrets to your repository.
- Deploys the worker to Cloudflare.

This will also automatically open a browser window to your new worker's URL:

![hello, worker!](https://github.com/user-attachments/assets/07e30305-f031-4058-ab96-df98c9f5615b)

## [Anchor for step-2-run-the-worker-locally](https://replicate.com/docs/guides/cloudflare-image-cache\#step-2-run-the-worker-locally) Step 2: Run the worker locally

Your new worker is now deployed to Cloudflare, but you can also run it locally.

Run the worker on your local machine to make sure everything is set up correctly:

Copy

```
cd placeholder-zoo
npm run dev
```

You should see output like this:

Copy

```
$ npm run dev

> placeholder-zoo@1.0.0 dev
> wrangler dev


 ⛅️ wrangler 3.88.0
-------------------

⎔ Starting local server...
[wrangler:inf] Ready on http://localhost:8787
╭───────────────────────────╮
│  [b] open a browser       │
│  [d] open devtools        │
│  [l] turn off local mode  │
│  [c] clear console        │
│  [x] to exit              │
╰───────────────────────────╯
```

Hit **b** to open the worker in your browser. You should see the "Hello, world!" message.

## [Anchor for step-3-set-up-secrets-for-your-worker](https://replicate.com/docs/guides/cloudflare-image-cache\#step-3-set-up-secrets-for-your-worker) Step 3: Set up secrets for your worker

Now that you've got your worker running locally, it's time to add some secrets so your app can make authenticated requests to Replicate and Cloudflare.

Start by creating a file called `.dev.vars`. Cloudflare uses this file to store secrets locally for your worker.

Copy

```
touch .dev.vars
```

Then add the following placeholder values to the `.dev.vars` file:

Copy

```
REPLICATE_API_TOKEN=
CLOUDFLARE_ACCOUNT_ID=
CLOUDFLARE_API_TOKEN=
CLOUDFLARE_IMAGE_ACCOUNT_HASH=
```

The values that go in this file are secrets, so you should treat them like passwords. Luckily, the `npm create cloudflare` command you ran created a `.gitignore` file that ignores the `.dev.vars` file, so you don't have to worry about accidentally committing it to your repository.

**Replicate API token**

You'll need a Replicate API token so you can start running models from your worker.

Go to [replicate.com/account/api-tokens](https://replicate.com/account/api-tokens) and create a new API token, then copy it to your clipboard.

Then paste your Replicate API token into the `.dev.vars` file for local development:

Copy

```
REPLICATE_API_TOKEN=r8_...
```

You'll also need to set the `REPLICATE_API_TOKEN` secret in your remote worker's configuration.

Start by logging into Cloudflare using the wrangler CLI:

Copy

```
npx wrangler login
```

Note: You'll use `npx wrangler` to run wrangler everywhere in this guide. Using npx ensures you're using the version of wrangler that is installed locally in the project, rather than a globally isntalled npm package, which can vary from one machine to another.

Then set your Replicate token as a secret on your deployed worker:

Copy

```
npx wrangler secret put REPLICATE_API_TOKEN
```

You should see output like this:

Copy

```
✔ Enter a secret value: … ****************************************
🌀 Creating the secret for the Worker "placeholder-zoo"
✨ Success! Uploaded secret REPLICATE_API_TOKEN
```

**Cloudflare account ID**

To find your Cloudflare account ID, run this command in the terminal:

Copy

```
npx wrangler whoami
```

Set the `CLOUDFLARE_ACCOUNT_ID` secret in your `.dev.vars` file for local development:

Copy

```
CLOUDFLARE_ACCOUNT_ID=...
```

You'll also need to set the `CLOUDFLARE_ACCOUNT_ID` secret in your remote worker's configuration:

Copy

```
npx wrangler secret put CLOUDFLARE_ACCOUNT_ID
```

**Cloudflare API token**

To create a Cloudflare API token for Cloudflare Images, do the following:

1. Go to [dash.cloudflare.com/profile/api-tokens](https://dash.cloudflare.com/profile/api-tokens)
2. Click "Create token".
3. Find the template called "Read and write to Cloudflare Stream and Images" and click **Use template**.
4. Scroll down and click **Continue to summary**.
5. Click **Create token**.
6. Copy the token to your clipboard.

Set the `CLOUDFLARE_API_TOKEN` secret in your `.dev.vars` file for local development:

Copy

```
CLOUDFLARE_API_TOKEN=...
```

You'll also need to set the `CLOUDFLARE_API_TOKEN` secret in your remote worker's configuration:

Copy

```
npx wrangler secret put CLOUDFLARE_API_TOKEN
```

**Cloudflare Images account hash**

You'll need your Cloudflare Images account hash so you can construct URLs to your generated images.

To find your Cloudflare Images account hash:

1. Go to [dash.cloudflare.com](https://dash.cloudflare.com/)
2. Click on the **Images** tab on the left.
3. Find the **Account Hash** on the right and copy it to your clipboard.

Set the `CLOUDFLARE_IMAGE_ACCOUNT_HASH` secret in your `.dev.vars` file for local development:

Copy

```
CLOUDFLARE_IMAGE_ACCOUNT_HASH=...
```

You'll also need to set the `CLOUDFLARE_IMAGE_ACCOUNT_HASH` secret in your remote worker's configuration:

Copy

```
npx wrangler secret put CLOUDFLARE_IMAGE_ACCOUNT_HASH
```

Now that you've added all the secrets, run this command to check that you've set them up correctly on your deployed worker:

Copy

```
npx wrangler secret list
```

You should see output like this:

Copy

```
[\
  {\
    "name": "CLOUDFLARE_ACCOUNT_ID",\
    "type": "secret_text"\
  },\
  {\
    "name": "CLOUDFLARE_API_TOKEN",\
    "type": "secret_text"\
  },\
  {\
    "name": "CLOUDFLARE_IMAGE_ACCOUNT_HASH",\
    "type": "secret_text"\
  },\
  {\
    "name": "REPLICATE_API_TOKEN",\
    "type": "secret_text"\
  }\
]
```

## [Anchor for step-4-run-replicate-models-from-your-worker](https://replicate.com/docs/guides/cloudflare-image-cache\#step-4-run-replicate-models-from-your-worker) Step 4: Run Replicate models from your worker

Now that your worker is running locally and your secrets are set up, you can start running models on Replicate from your worker code.

Install the [`replicate`](https://npm.im/replicate) npm package:

Copy

```
npm install replicate
```

Create a new file called `src/image-generator.ts`:

Copy

```
touch src/image-generator.ts
```

Paste the following code into the file:

Copy

```
import Replicate from 'replicate'

interface Env {
  REPLICATE_API_TOKEN: string
}

export async function generateImage(prompt: string, env: Env) {
  const replicate = new Replicate({auth: env.REPLICATE_API_TOKEN})
  const model = 'black-forest-labs/flux-schnell'
  const output = await replicate.run(model, {
    input: {
      prompt,
      image_format: 'webp',
    }
  })

  // Some image models return an array of output files, others just a single file.
  const imageUrl = Array.isArray(output) ? output[0].url() : output.url()

  console.log({imageUrl})

  return imageUrl
}
```

Then create a new file called `src/homepage.ts`:

Copy

```
touch src/homepage.ts
```

Then paste the following code into the `src/homepage.ts` file:

Copy

```
export function homepage(): Response {
  const html = `
    <html>
      <body>
        <h1>Placeholder Zoo</h1>
        <p>Examples:</p>
        <ul>
          <li><a href="/800x600/sunglasses-sloth">/800x600/sunglasses-sloth</a></li>
          <li><a href="/512x512/psychic-goat">/512x512/psychic-goat</a></li>
          <li><a href="/1024x768/hippie-lion">/1024x768/hippie-lion</a></li>
          <li><a href="/600x800/punk-giraffe">/600x800/punk-giraffe</a></li>
        </ul>
      </body>
    </html>
  `;
  return new Response(html, {
    status: 200,
    headers: { 'Content-Type': 'text/html' }
  });
}
```

Replace the contents of your `src/index.ts` file with the following code:

Copy

```
import { homepage } from './homepage'
import { generateImage } from './image-generator'

export interface Env {
  REPLICATE_API_TOKEN: string
  CLOUDFLARE_ACCOUNT_ID: string
  CLOUDFLARE_API_TOKEN: string
  CLOUDFLARE_IMAGE_ACCOUNT_HASH: string
  IMAGE_CACHE: KVNamespace
}

export default {
  async fetch(request: Request, env: Env, ctx: ExecutionContext): Promise<Response> {
    const url = new URL(request.url)

    // Example: /800x600/sunglasses-sloth
    const [dimensions, animal] = url.pathname.split('/').filter(Boolean)

    // Render the homepage if the path is invalid
    if (!dimensions || !animal) return homepage()

    // Turn `/800x600/sunglasses-sloth` into a text prompt
    const [targetWidth, targetHeight] = dimensions.toLowerCase().split('x').map(n => Number.parseInt(n, 10))
    const prompt = `A high-quality image of a ${animal} holding up a sign with the words "${targetWidth} by ${targetHeight}"`

    // Generate the image
    const imageUrl = await generateImage(prompt, env)

    // Fetch the image and return it
    const imageResponse = await fetch(imageUrl)
    return new Response(imageResponse.body, {
      headers: {
        'content-type': 'image/webp',
      }
    })
  }
}
```

Now run the worker again:

Copy

```
npm run dev
```

Open this URL in your browser: [localhost:8787/1600x900/cinephile-rat](http://localhost:8787/1600x900/cinephile-rat)

You should see a generated image that looks something like this:

![cinephile-rat](https://github.com/user-attachments/assets/dc3b4697-e180-45b2-9b06-0ab9765f18a6)

This is another good time to commit your changes to Git:

Copy

```
git add .
git commit -m "Run Replicate models from the worker"
```

## [Anchor for step-5-store-your-generated-images-in-cloudflare](https://replicate.com/docs/guides/cloudflare-image-cache\#step-5-store-your-generated-images-in-cloudflare) Step 5: Store your generated images in Cloudflare

When you run models with Replicate's API, any output files generated by the model are returned as HTTPS URLs that are automatically deleted after an hour.
If you want to keep your output files for longer than an hour, you need to save a copy of them somewhere.

You'll use [Cloudflare Images](https://developers.cloudflare.com/images) to store your generated images, and [Cloudflare KV](https://developers.cloudflare.com/kv/) as a key-value datastore so you can do quick lookups of images that have already been generated.

Create a new file called `src/image-uploader.ts`:

Copy

```
touch src/image-uploader.ts
```

Then add the following code to the file:

Copy

```
interface CloudflareEnv {
  CLOUDFLARE_ACCOUNT_ID: string
  CLOUDFLARE_API_TOKEN: string
}

interface UploadResponse {
  result: {
    id: string
    variants: string[]
  }
}

export async function uploadToCloudflareImages (imageUrl: string, env: CloudflareEnv): Promise<string> {
  console.log('Uploading image to Cloudflare Images:', imageUrl)

  const imageResponse = await fetch(imageUrl)
  const imageBlob = await imageResponse.blob()
  const formData = new FormData()
  formData.append('file', imageBlob)
  const uploadResponse = await fetch(
    `https://api.cloudflare.com/client/v4/accounts/${env.CLOUDFLARE_ACCOUNT_ID}/images/v1`,
    {
      method: 'POST',
      headers: {
        Authorization: `Bearer ${env.CLOUDFLARE_API_TOKEN}`
      },
      body: formData
    }
  )

  const result = (await uploadResponse.json()) as UploadResponse

  if (!uploadResponse.ok) {
    console.error('Failed to upload to Cloudflare Images:', result)
    throw new Error('Failed to upload image')
  }

  console.log('Successfully uploaded to Cloudflare Images:', result)

  return result.result.id
}
```

Then add this line to your `src/index.ts` file, after the `generateImage` function:

Copy

```
// Upload the image to Cloudflare Images
const cloudflareImageId = await uploadToCloudflareImages(imageUrl, env)
```

## [Anchor for step-6-cache-metadata-in-cloudflare-kv](https://replicate.com/docs/guides/cloudflare-image-cache\#step-6-cache-metadata-in-cloudflare-kv) Step 6: Cache metadata in Cloudflare KV

Each time you upload an image to Cloudflare Images, you'll also store some metadata about the image in Cloudflare KV. This will let you quickly look up whether an image has already been generated, so you can return the existing image without re-running the model.

Use Wrangler to create a new KV namespace:

Copy

```
npx wrangler kv:namespace create "IMAGE_CACHE"
```

You should see output like this:

Copy

```
 ⛅️ wrangler 3.88.0
-------------------

🌀 Creating namespace with title "placeholder-zoo-IMAGE_CACHE"
✨ Success!
Add the following to your configuration file in your kv_namespaces array:
[[kv_namespaces]]
binding = "IMAGE_CACHE"
id = "3c8ce31144a0467080700b241fb6bfdc"
```

The "configuration file" the above message is referring to is your `wrangler.toml` file.

Next, update your worker code to check the KV store before generating an image, and cache the generated image ID in KV if it's not already cached.

You'll store the request pathname (e.g. `/800x600/sunglasses-sloth`) as a key, and the Cloudflare Images ID (e.g. `ab6b3a38-1957-4b8d-91de-3aadf0f22211`) as the value.

Overwrite the contents of your `src/index.ts` file with the following code:

Copy

```
import { homepage } from './homepage'
import { uploadToCloudflareImages } from './image-uploader'
import { generateImage } from './image-generator'

export interface Env {
  REPLICATE_API_TOKEN: string
  CLOUDFLARE_ACCOUNT_ID: string
  CLOUDFLARE_API_TOKEN: string
  CLOUDFLARE_IMAGE_ACCOUNT_HASH: string
  IMAGE_CACHE: KVNamespace
}

export default {
  async fetch(request: Request, env: Env, ctx: ExecutionContext): Promise<Response> {
    const url = new URL(request.url)

    // Example: /800x600/sunglasses-sloth
    const [dimensions, animal] = url.pathname.split('/').filter(Boolean)

    // Render the homepage if the path is invalid
    if (!dimensions || !animal) return homepage()

    // Turn `/800x600/sunglasses-sloth` into a text prompt
    const [targetWidth, targetHeight] = dimensions.toLowerCase().split('x').map(n => Number.parseInt(n, 10))
    const prompt = `A high-quality image of a ${animal} holding up a sign with the words "${targetWidth} by ${targetHeight}"`

    // Check for a cached image id that matches this request URL
    const cacheKey = url.pathname

    // If the request has a `?redo` query param, we'll bypass the cache
    const shouldBypassCache = url.searchParams.has('redo')
    const cachedImageId = shouldBypassCache ? null : await env.IMAGE_CACHE.get(cacheKey)
    let cloudflareImageId: string

    if (cachedImageId) {
      console.log('Cache hit for:', cacheKey)
      cloudflareImageId = cachedImageId
    } else {
      console.log(shouldBypassCache ? 'Bypassing cache due to redo parameter' : 'Cache miss for:', cacheKey)

      // Generate the image
      const replicateImageUrl = await generateImage(prompt, env)
      console.log('Generated image URL:', replicateImageUrl)

      // Upload the image to Cloudflare Images
      cloudflareImageId = await uploadToCloudflareImages(replicateImageUrl, env)
      console.log('Cloudflare Images ID:', cloudflareImageId)

      // Cache the image ID
      await env.IMAGE_CACHE.put(cacheKey, cloudflareImageId)
      console.log('Stored in cache:', cacheKey, cloudflareImageId)
    }

    const transformations = {
      width: targetWidth,
      height: targetHeight,
      fit: "cover"
    }

    const transformationsString = Object.entries(transformations).map(([k,v]) => `${k}=${v}`).join(',')

    const transformedImageUrl = `https://imagedelivery.net/${env.CLOUDFLARE_IMAGE_ACCOUNT_HASH}/${cloudflareImageId}/${transformationsString}`;
    console.log({transformedImageUrl})

    // Fetch the image and return it
    const imageResponse = await fetch(transformedImageUrl)
    return new Response(imageResponse.body, {
      headers: {
        'content-type': 'image/webp',
      }
    })
  }
}
```

## [Anchor for step-7-deploy-your-updated-worker](https://replicate.com/docs/guides/cloudflare-image-cache\#step-7-deploy-your-updated-worker) Step 7: Deploy your updated worker

You've been iterating on your worker locally, so now it's time to deploy your changes to Cloudflare:

Copy

```
npm run deploy
```

You should see output like this:

Copy

```
Deployed placeholder-zoo triggers (0.32 sec)
  https://placeholder-zoo.ziki.workers.dev
```

Go to the URL in the output and you should see a landing page with links to example images.

* * *

If you encounter any errors when running your remote worker, you can use the `wrangler tail` command to see the logs:

Copy

```
npx wrangler tail
```

## [Anchor for next-steps](https://replicate.com/docs/guides/cloudflare-image-cache\#next-steps) Next steps

Congratulations! You've built a Cloudflare Worker that:

- Generates images using Replicate.
- Caches output files in durable storage on Cloudflare.
- Serves images dynamically with [transformations](https://developers.cloudflare.com/images/transform-images/transform-via-url/) like scaling, cropping, and filters.

Here are some suggestions for next steps:

- Experiment with different [image generation models](https://replicate.com/collections/text-to-image) to see which one works best for you.
- Try different [image transformations](https://developers.cloudflare.com/images/transform-images/transform-via-url/).
- Use a [GitHub Actions workflow](https://github.com/marketplace/actions/deploy-to-cloudflare-workers-with-wrangler) to automatically deploy your worker when you push changes to your GitHub repo.

Happy hacking!

[Next:Build a realtime speech app with OpenAI, Cloudflare, and Replicate](https://replicate.com/docs/guides/openai-realtime)

# Docs

Get started

Collapse sidebar

[Run a model from Node.js](https://replicate.com/docs/get-started/nodejs) [Run a model from Google Colab](https://replicate.com/docs/get-started/google-colab) [Run a model from Python](https://replicate.com/docs/get-started/python) [Fine-tune an image model](https://replicate.com/docs/get-started/fine-tune-with-flux)

Guides

[Build a website with Next.js](https://replicate.com/docs/guides/nextjs) [Build a Discord bot with Python](https://replicate.com/docs/guides/discord-bot) [Build an app with SwiftUI](https://replicate.com/docs/guides/swiftui) [Cache images with Cloudflare](https://replicate.com/docs/guides/cloudflare-image-cache) [Use realtime speech with OpenAI](https://replicate.com/docs/guides/openai-realtime) [Push your own model](https://replicate.com/docs/guides/push-a-model) [Push a Diffusers model](https://replicate.com/docs/guides/push-a-diffusers-model) [Push a Transformers model](https://replicate.com/docs/guides/push-a-transformers-model) [Handle webhooks with Val Town](https://replicate.com/docs/guides/build-a-webhook-notifier-with-val-town) [Deploy a custom model](https://replicate.com/docs/guides/deploy-a-custom-model) [Push a model using GitHub Actions](https://replicate.com/docs/guides/push-a-model-using-github-actions) [Set up a CI/CD pipeline](https://replicate.com/docs/guides/continuous-model-deployment) [Get a GPU on Brev](https://replicate.com/docs/guides/get-a-gpu-on-brev) [Get a GPU on Lambda Labs](https://replicate.com/docs/guides/get-a-gpu-on-lambda-labs) [Working with LoRAs](https://replicate.com/docs/guides/working-with-loras)

ComfyUI

[Craft generative AI workflows with ComfyUI](https://replicate.com/docs/guides/comfyui) [Use ComfyUI manager](https://replicate.com/docs/guides/comfyui/comfyui-manager) [Start by running the ComfyUI examples](https://replicate.com/docs/guides/comfyui/examples) [Popular ComfyUI custom nodes](https://replicate.com/docs/guides/comfyui/custom-nodes) [Run your ComfyUI workflow on Replicate](https://replicate.com/docs/guides/comfyui/run-comfyui-on-replicate) [Run ComfyUI with an API](https://replicate.com/docs/guides/comfyui/run-comfyui-with-an-api)

Hypermedia

[Build AI apps fast with hypermedia](https://replicate.com/docs/guides/hypermedia) [What is hypermedia, and why use it for AI apps?](https://replicate.com/docs/guides/hypermedia/what-is-hypermedia) [Building a face swapping app with Val Town, HTMX, and Replicate](https://replicate.com/docs/guides/hypermedia/build-hypermedia-app)

Instant ID

[Make images of real people instantly with InstantID](https://replicate.com/docs/guides/instant-id) [Run InstantID with an API](https://replicate.com/docs/guides/instant-id/run-instant-id-with-an-api)

Language models

[Prompt and run open-source large language models (LLMs)](https://replicate.com/docs/guides/language-models) [How to use open source language models](https://replicate.com/docs/guides/language-models/how-to-use) [Use cases for open source language models](https://replicate.com/docs/guides/language-models/use-cases) [Popular open source language models and their use cases](https://replicate.com/docs/guides/language-models/popular-models) [How to prompt open source large language models](https://replicate.com/docs/guides/language-models/how-to-prompt) [Advanced prompting for open source large language models](https://replicate.com/docs/guides/language-models/advanced-prompting)

Llava

[Talk to images with Llava 13B](https://replicate.com/docs/guides/llava)

Model best practices

[Best practices for Replicate models](https://replicate.com/docs/guides/model-best-practices)

Photomaker

[Generate photos of real people with Photomaker](https://replicate.com/docs/guides/photomaker)

Stable Diffusion

[Make art with Stable Diffusion](https://replicate.com/docs/guides/stable-diffusion) [How to use Stable Diffusion](https://replicate.com/docs/guides/stable-diffusion/how-to-use) [Image to image (img2img) with Stable Diffusion](https://replicate.com/docs/guides/stable-diffusion/image-to-image) [Inpainting with Stable Diffusion](https://replicate.com/docs/guides/stable-diffusion/inpainting) [Outpainting with Stable Diffusion](https://replicate.com/docs/guides/stable-diffusion/outpainting) [Fine-tuning Stable Diffusion](https://replicate.com/docs/guides/stable-diffusion/fine-tuning) [Using ControlNet with Stable Diffusion](https://replicate.com/docs/guides/stable-diffusion/controlnet) [Fast Stable Diffusion: Turbo and latent consistency models (LCMs)](https://replicate.com/docs/guides/stable-diffusion/turbo-and-latent-consistency) [A to Z of Stable Diffusion](https://replicate.com/docs/guides/stable-diffusion/glossary)

Upscaling images

[Upscale images with AI models](https://replicate.com/docs/guides/upscaling-images) [Upscaling images with Real-ESRGAN](https://replicate.com/docs/guides/upscaling-images/real-esrgan) [Fixing faces with GFPGAN and Codeformer](https://replicate.com/docs/guides/upscaling-images/gfpgan-and-codeformer) [Upscaling images with SwinIR](https://replicate.com/docs/guides/upscaling-images/swinir) [Upscaling images with ControlNet tile](https://replicate.com/docs/guides/upscaling-images/controlnet-tile) [Upscaling images with Ultimate SD Upscale](https://replicate.com/docs/guides/upscaling-images/sd-ultimate-upscale)

Whisper

[Turn speech to text with WhisperX](https://replicate.com/docs/guides/whisper) [Run WhisperX with an API](https://replicate.com/docs/guides/whisper/run-whisperx-with-an-api)

Topics

Models

[About models](https://replicate.com/docs/topics/models) [Run a model](https://replicate.com/docs/topics/models/run-a-model) [Create a model](https://replicate.com/docs/topics/models/create-a-model) [Publish a model](https://replicate.com/docs/topics/models/publish-a-model) [Model versions](https://replicate.com/docs/topics/models/versions) [Model hardware](https://replicate.com/docs/topics/models/hardware) [Private and public models](https://replicate.com/docs/topics/models/private-models) [Training destinations](https://replicate.com/docs/topics/models/models-as-training-destinations) [Delete a model](https://replicate.com/docs/topics/models/delete-a-model)

Predictions

[About predictions](https://replicate.com/docs/topics/predictions) [Create a prediction](https://replicate.com/docs/topics/predictions/create-a-prediction) [Input files](https://replicate.com/docs/topics/predictions/input-files) [Output files](https://replicate.com/docs/topics/predictions/output-files) [Prediction lifecycle](https://replicate.com/docs/topics/predictions/lifecycle) [Share a prediction](https://replicate.com/docs/topics/predictions/share-a-prediction) [Rate limits](https://replicate.com/docs/topics/predictions/rate-limits) [Safety checking](https://replicate.com/docs/topics/predictions/safety-checking) [Data retention](https://replicate.com/docs/topics/predictions/data-retention) [Streaming output](https://replicate.com/docs/topics/predictions/streaming)

Deployments

[About deployments](https://replicate.com/docs/topics/deployments) [Create a deployment](https://replicate.com/docs/topics/deployments/create-a-deployment) [View deployments](https://replicate.com/docs/topics/deployments/view-deployments) [Delete a deployment](https://replicate.com/docs/topics/deployments/delete-a-deployment)

Webhooks

[About webhooks](https://replicate.com/docs/topics/webhooks) [Set up webhooks](https://replicate.com/docs/topics/webhooks/setup-webhook) [Receive webhooks](https://replicate.com/docs/topics/webhooks/receive-webhook) [Verify webhooks](https://replicate.com/docs/topics/webhooks/verify-webhook) [Test your webhook code](https://replicate.com/docs/topics/webhooks/testing-webhook-code)

Organizations

[About organizations](https://replicate.com/docs/topics/organizations)

Billing

[About billing](https://replicate.com/docs/topics/billing)

Site policy

[About subprocessors](https://replicate.com/docs/topics/site-policy/subprocessors)

Reference

[How does Replicate work?](https://replicate.com/docs/reference/how-does-replicate-work) [Client libraries](https://replicate.com/docs/reference/client-libraries) [HTTP API](https://replicate.com/docs/reference/http) [OpenAPI schema](https://replicate.com/docs/reference/openapi) [Open source](https://replicate.com/docs/reference/open-source)

Close

Popular searches on Replicate

- [Run a model from Node.js](https://replicate.com/docs/get-started/nodejs)
- [Deploy a custom model](https://replicate.com/docs/guides/deploy-a-custom-model)
- [How does Replicate work?](https://replicate.com/docs/reference/how-does-replicate-work)

Showing 0 results